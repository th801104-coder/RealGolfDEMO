<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Real Golf</title>

<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  font-family:sans-serif;
  padding-bottom: env(safe-area-inset-bottom);
}

/* ===== オープニング ===== */
#startScreen{
  position:fixed;
  inset:0;
  background:url("https://images.unsplash.com/photo-1592919505780-303950717480?q=80&w=1600") center/cover;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  color:white;
  z-index:100;
}
#startScreen h1{
  font-size:48px;
  text-shadow:0 4px 20px rgba(0,0,0,.6);
}
#startBtn{
  padding:12px 24px;
  border:none;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
}

/* ===== ゲーム画面 ===== */
#layout{
  display:flex;
  width:100vw;
  height:100%;
}

/* ===== 左：コース ===== */
#left{
  width:50vw;
  position:relative;
  background:#0f5f2a url("assets/course.png") center/contain no-repeat;
}

#ballCanvas{
  position:absolute;
  inset:0;
}

/* 風 */
#windInfo{
  position:absolute;
  top:10px;
  left:10px;
  background:rgba(0,0,0,.5);
  color:white;
  padding:6px 10px;
  border-radius:8px;
  font-size:14px;
  z-index:10;
}

/* ホール情報（箱） */
#holeInfo{
  position:absolute;
  top:52px;
  left:10px;
  width:200px;
  background:rgba(0,0,0,.45);
  color:#fff;
  padding:10px 12px;
  border-radius:10px;
  font-size:14px;
  font-weight:900;
  z-index:10;
  border:1px solid rgba(255,255,255,.15);
  line-height:1.25;
}

/* エイム（矢印）操作 */
#aimControls{
  position:absolute;
  top:122px; /* holeInfoの下 */
  left:10px;
  z-index:10;
  display:flex;
  gap:8px;
  align-items:center;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.12);
  color:#fff;
  padding:8px 10px;
  border-radius:10px;
  backdrop-filter: blur(2px);
}
#aimControls button{
  padding:8px 10px;
  border:none;
  border-radius:10px;
  font-weight:900;
  cursor:pointer;
}
#aimLabel{
  font-weight:900;
  font-size:13px;
  opacity:.95;
}

/* NiceON表示 */
#banner{
  position:absolute;
  top:96px;
  left:10px;
  right:10px;
  text-align:center;
  z-index:20;
  pointer-events:none;
  display:none;
}
#banner span{
  display:inline-block;
  background:rgba(0,0,0,.55);
  color:#fff;
  padding:10px 14px;
  border-radius:12px;
  font-weight:900;
  letter-spacing:.06em;
}

/* クラブ */
.club-buttons{
  position:absolute;
  bottom:70px;
  left:10px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  z-index:10;
}
.club-buttons button{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  font-size:14px;
}
.club-buttons button.active{
  outline:3px solid gold;
}

/* ===== 右 ===== */
#right{
  width:50vw;
  display:flex;
  flex-direction:column;
}

#impactZone{
  flex:1;
  background:#111;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
}
#ballUI{
  width:220px;
  height:220px;
  position:relative;
}

/* ゴルフボール */
#ballCircle{
  width:100%;
  height:100%;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%, white, #ddd);
  position:relative;
  overflow:hidden;
}
.dimple{
  position:absolute;
  width:8px;
  height:8px;
  border-radius:50%;
  background:rgba(0,0,0,.08);
}

/* ＋カーソル（クラブ選択後のみ表示） */
#impactCursor{
  position:absolute;
  width:40px;
  height:40px;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  display:none;
}
#impactCursor::before,
#impactCursor::after{
  content:"";
  position:absolute;
  background:black;
}
#impactCursor::before{
  width:6px;
  height:100%;
  left:50%;
  transform:translateX(-50%);
}
#impactCursor::after{
  height:6px;
  width:100%;
  top:50%;
  transform:translateY(-50%);
}

/* プレイヤー */
#playerZone{
  flex:1;
  background:linear-gradient(#2b8f44,#1f8f3a);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  overflow:hidden;
}
#golferImg{
  height:80%;
  object-fit:contain;
  transition:transform .3s;
}
.swing{
  transform:rotate(25deg);
}

/* ===== グリーンモード（仮） ===== */
#greenOverlay{
  position:fixed;
  inset:0;
  background:linear-gradient(#2f9e48,#177a36);
  display:none;
  z-index:200;
  color:#fff;
  padding:16px;
}
#greenOverlay h2{
  margin:0 0 10px 0;
  font-size:22px;
}
#backToCourse{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- オープニング -->
<div id="startScreen">
  <h1>REAL GOLF!</h1>
  <button id="startBtn">START</button>
</div>

<!-- グリーンモード（仮画面） -->
<div id="greenOverlay">
  <h2>GREEN MODE</h2>
  <p>（次はここに傾斜ライン＋パター操作を入れます）</p>
  <button id="backToCourse">コースに戻る</button>
</div>

<!-- ゲーム -->
<div id="layout" style="display:none;">

  <div id="left">
    <canvas id="ballCanvas"></canvas>
    <div id="windInfo"></div>

    <div id="holeInfo">1H Par4<br>Rest360 First</div>

    <div id="aimControls">
      <button id="aimLeft" aria-label="aim left">◀</button>
      <div id="aimLabel">Aim: 0</div>
      <button id="aimRight" aria-label="aim right">▶</button>
    </div>

    <div id="banner"><span>NiceON</span></div>

    <div class="club-buttons">
      <button data-power="220">1W</button>
      <button data-power="190">3W</button>
      <button data-power="160">5I</button>
      <button data-power="140">7I</button>
      <button data-power="110">9I</button>
      <button data-power="60">SW</button>
    </div>
  </div>

  <div id="right">
    <div id="impactZone">
      <div id="ballUI">
        <div id="ballCircle"></div>
        <div id="impactCursor"></div>
      </div>
    </div>

    <div id="playerZone">
      <img id="golferImg" src="assets/golfer.png" alt="golfer">
    </div>
  </div>

</div>

<script>
/* ===== iPhone Safariの100vh問題対策 ===== */
function setRealHeight(){
  document.body.style.height = window.innerHeight + "px";
}
window.addEventListener("resize", setRealHeight);
setRealHeight();

/* ===== スタート ===== */
document.getElementById("startBtn").onclick = ()=>{
  document.getElementById("startScreen").style.display="none";
  document.getElementById("layout").style.display="flex";
  setTimeout(()=>{ resize(); resetHole(); }, 50);
};

/* ===== グリーンモード（仮） ===== */
const greenOverlay = document.getElementById("greenOverlay");
document.getElementById("backToCourse").onclick = ()=>{
  greenOverlay.style.display="none";
};

/* ===== ディンプル生成 ===== */
const ballCircle = document.getElementById("ballCircle");
for(let i=0;i<90;i++){
  const d=document.createElement("div");
  d.className="dimple";
  d.style.left=Math.random()*100+"%";
  d.style.top=Math.random()*100+"%";
  ballCircle.appendChild(d);
}

/* ===== 左canvas ===== */
const canvas = document.getElementById("ballCanvas");
const ctx = canvas.getContext("2d");

/* ---- 風 ---- */
let windSpeed = Math.random()*2;
let windDir = Math.random()*360;

function updateWindUI(){
  document.getElementById("windInfo").innerText =
    `風向:${Math.floor(windDir)}° 風速:${windSpeed.toFixed(1)}m`;
}
updateWindUI();

/* =========================================================
   ★ティー＆グリーンの位置（添付画像ベースで“だいたい”）
   - 赤丸の中心 → ティー
   - 黄丸の中心 → グリーン
   - 黄丸の大きさ → グリーン半径
   ここを微調整すれば、ピッタリ合います。
========================================================= */
const TEE_X_RATIO   = 0.38;  // 赤丸中心（だいたい）
const TEE_Y_RATIO   = 0.82;  // 赤丸中心（だいたい）

const GREEN_X_RATIO = 0.33;  // 黄丸中心（だいたい）
const GREEN_Y_RATIO = 0.12;  // 黄丸中心（だいたい）

const GREEN_RADIUS_RATIO = 0.10; // 黄丸の大きさ（だいたい）※短辺基準

function getTeePos(){
  return { x: canvas.width*TEE_X_RATIO, y: canvas.height*TEE_Y_RATIO };
}
function getGreenCenter(){
  return { x: canvas.width*GREEN_X_RATIO, y: canvas.height*GREEN_Y_RATIO };
}
function getGreenRadius(){
  return Math.min(canvas.width, canvas.height) * GREEN_RADIUS_RATIO;
}

/* ---- 距離表示（RestXXX） ---- */
const HOLE_YARDS = 360; // Par4想定
function remainingYards(){
  const g = getGreenCenter();
  const d = Math.hypot(ball.x - g.x, ball.y - g.y);

  const tee = getTeePos();
  const base = Math.hypot(tee.x - g.x, tee.y - g.y) || 1;

  const yards = Math.max(0, Math.round((d / base) * HOLE_YARDS));
  return yards;
}

/* ---- 打数表示（英語、先頭大文字） ---- */
const ORDINALS = [
  "first","second","third","fourth","fifth",
  "sixth","seventh","eighth","ninth","tenth",
  "eleventh","twelfth","thirteenth","fourteenth","fifteenth"
];
function cap1(s){ return s ? (s[0].toUpperCase()+s.slice(1)) : s; }
function nextStrokeWord(){
  const n = stroke + 1; // 次に打つ番
  return cap1(ORDINALS[n-1] || (n + "th"));
}
function updateHoleInfo(){
  const y = remainingYards();
  document.getElementById("holeInfo").innerHTML =
    `1H Par4<br>Rest${y} ${nextStrokeWord()}`;
}

/* ===== エイム（矢印） =====
   aimLevel: -2,-1,0,1,2 の5段階
*/
let aimLevel = 0;
const AIM_MIN = -2;
const AIM_MAX =  2;
const AIM_STEP_DEG = 7;

function updateAimUI(){
  document.getElementById("aimLabel").textContent = `Aim: ${aimLevel}`;
}
updateAimUI();

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

document.getElementById("aimLeft").addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  if(isBallMoving) return;
  aimLevel = clamp(aimLevel - 1, AIM_MIN, AIM_MAX);
  updateAimUI();
  draw();
});
document.getElementById("aimRight").addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  if(isBallMoving) return;
  aimLevel = clamp(aimLevel + 1, AIM_MIN, AIM_MAX);
  updateAimUI();
  draw();
});

/* ---- 状態 ---- */
let stroke = 0;
let clubPower = 0;
let ball = { x: 0, y: 0 };
let velocity = { x: 0, y: 0 };
let isBallMoving = false;

let phase = "idle";
let cursorY = 0;
let cursorX = 0;
let direction = 1;

/* ショットは「飛行フレーム数」だけ動いて着地即停止 */
let flightFrame = 0;
let flightFramesTotal = 0;

/* ===== canvasサイズ ===== */
function resize(){
  canvas.width = canvas.parentElement.clientWidth;
  canvas.height = canvas.parentElement.clientHeight;
}
window.addEventListener("resize", ()=>{ resize(); draw(); });
resize();

/* ===== リセット ===== */
function resetHole(){
  stroke = 0;
  clubPower = 0;
  phase = "idle";
  isBallMoving = false;
  velocity.x = velocity.y = 0;

  flightFrame = 0;
  flightFramesTotal = 0;

  aimLevel = 0;
  updateAimUI();

  const tee = getTeePos();
  ball.x = tee.x;
  ball.y = tee.y;

  document.getElementById("impactCursor").style.display = "none";
  updateHoleInfo();
  draw();
}

/* ===== 矢印描画 ===== */
function drawArrow(fromX, fromY, angleRad, length){
  const toX = fromX + Math.cos(angleRad) * length;
  const toY = fromY + Math.sin(angleRad) * length;

  ctx.save();
  ctx.lineCap = "round";
  ctx.lineJoin = "round";

  // 縁取り
  ctx.strokeStyle = "rgba(255,255,255,.65)";
  ctx.lineWidth = 8;
  ctx.beginPath();
  ctx.moveTo(fromX, fromY);
  ctx.lineTo(toX, toY);
  ctx.stroke();

  // 本体
  ctx.strokeStyle = "rgba(0,0,0,.75)";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(fromX, fromY);
  ctx.lineTo(toX, toY);
  ctx.stroke();

  // 矢尻
  const headLen = 14;
  const a1 = angleRad + Math.PI * 0.85;
  const a2 = angleRad - Math.PI * 0.85;

  ctx.fillStyle = "rgba(0,0,0,.75)";
  ctx.beginPath();
  ctx.moveTo(toX, toY);
  ctx.lineTo(toX + Math.cos(a1)*headLen, toY + Math.sin(a1)*headLen);
  ctx.lineTo(toX + Math.cos(a2)*headLen, toY + Math.sin(a2)*headLen);
  ctx.closePath();
  ctx.fill();

  ctx.restore();
}

/* ★矢印は常に「グリーン中心」を向く（＋左右微調整） */
function getAimAngleRad(){
  const g = getGreenCenter();
  const dx = g.x - ball.x;
  const dy = g.y - ball.y;
  const baseAngle = Math.atan2(dy, dx);
  const offset = (aimLevel * AIM_STEP_DEG) * Math.PI / 180;
  return baseAngle + offset;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // エイム矢印（常にグリーン方向）
  const aimAngle = getAimAngleRad();
  ctx.save();
  if(isBallMoving) ctx.globalAlpha = 0.35;
  drawArrow(ball.x, ball.y, aimAngle, Math.min(canvas.width, canvas.height) * 0.18);
  ctx.restore();

  // ボール
  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, 6, 0, Math.PI*2);
  ctx.fill();

  // デバッグ
  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.font="12px sans-serif";
  ctx.fillText(`Stroke: ${stroke}`, 10, canvas.height-10);
}

/* ===== ボール移動：着地したら即停止 ===== */
function animate(){
  if(isBallMoving){
    // 飛行中の移動
    ball.x += velocity.x;
    ball.y += velocity.y;

    // 風のドリフト（飛行中だけ）
    const wx = Math.cos(windDir*Math.PI/180) * windSpeed * 0.18;
    const wy = Math.sin(windDir*Math.PI/180) * windSpeed * 0.18;
    ball.x += wx;
    ball.y += wy;

    flightFrame++;

    // 着地：完全停止
    if(flightFrame >= flightFramesTotal){
      isBallMoving = false;
      velocity.x = 0;
      velocity.y = 0;

      if(isOnGreen()){
        showNiceOnAndSwitch();
      }
    }
  }

  updateHoleInfo();
  draw();
  requestAnimationFrame(animate);
}
animate();

/* ★黄丸に入ったらNiceOn */
function isOnGreen(){
  const g = getGreenCenter();
  const r = getGreenRadius();
  return Math.hypot(ball.x - g.x, ball.y - g.y) <= r;
}

function showNiceOnAndSwitch(){
  const banner = document.getElementById("banner");
  banner.style.display = "block";

  setTimeout(()=>{
    banner.style.display = "none";
    greenOverlay.style.display = "block";
  }, 1000);
}

/* ===== クラブ ===== */
document.querySelectorAll(".club-buttons button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".club-buttons button")
      .forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    clubPower = Number(btn.dataset.power);

    phase = "vertical";
    cursorX = 0;
    cursorY = 0;
    direction = 1;

    const cursor = document.getElementById("impactCursor");
    cursor.style.display = "block";
    cursor.style.left = "50%";
    cursor.style.top  = "50%";
  };
});

/* ===== カーソル移動 ===== */
function moveCursor(){
  const cursor = document.getElementById("impactCursor");

  if(phase==="vertical"){
    cursorY += direction*2;
    if(cursorY>50 || cursorY<-50) direction*=-1;
    cursor.style.top = (50 + cursorY) + "%";
    cursor.style.left = "50%";
  }else if(phase==="horizontal"){
    cursorX += direction*2;
    if(cursorX>50 || cursorX<-50) direction*=-1;
    cursor.style.left = (50 + cursorX) + "%";
    cursor.style.top  = "50%";
  }else{
    cursor.style.left = "50%";
    cursor.style.top  = "50%";
  }
  requestAnimationFrame(moveCursor);
}
moveCursor();

/* ===== タップ順 ===== */
document.getElementById("impactZone").addEventListener("click",()=>{
  if(clubPower<=0) return;
  if(isBallMoving) return;

  if(phase==="vertical"){
    phase="horizontal";
    direction=1;
  }else if(phase==="horizontal"){
    phase="done";
    swingAndShot();
  }
});

function swingAndShot(){
  const golfer=document.getElementById("golferImg");
  golfer.classList.add("swing");
  setTimeout(()=>golfer.classList.remove("swing"),300);

  stroke += 1;

  // 方向は矢印方向（＝グリーン方向＋左右微調整）
  const aimAngle = getAimAngleRad();
  const nx = Math.cos(aimAngle);
  const ny = Math.sin(aimAngle);

  // 縦カーソルで強弱
  const forwardScale = 1 + (-cursorY * 0.004);

  // 横カーソルは“ブレ”として少し（不要なら 0 に）
  const sideScale    = (cursorX * 0.004);

  const speed = clubPower * 0.03;

  const px = -ny;
  const py = nx;

  velocity.x = nx * speed * forwardScale + px * speed * sideScale;
  velocity.y = ny * speed * forwardScale + py * speed * sideScale;

  // ★飛距離：少し長め（短い場合はここを上げる）
  flightFrame = 0;
  flightFramesTotal = Math.round(30 + speed * 3.2);

  isBallMoving = true;

  setTimeout(()=>{
    phase="idle";
    document.getElementById("impactCursor").style.display="none";
    cursorX=0; cursorY=0;
  }, 650);
}
</script>

</body>
</html>
