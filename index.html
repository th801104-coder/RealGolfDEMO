<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Real Golf</title>

<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  font-family:sans-serif;
  padding-bottom: env(safe-area-inset-bottom);
}

/* ===== オープニング ===== */
#startScreen{
  position:fixed;
  inset:0;
  background:url("https://images.unsplash.com/photo-1592919505780-303950717480?q=80&w=1600") center/cover;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  color:white;
  z-index:100;
}
#startScreen h1{
  font-size:48px;
  text-shadow:0 4px 20px rgba(0,0,0,.6);
}
#startBtn{
  padding:12px 24px;
  border:none;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
}

/* ===== ゲーム画面 ===== */
#layout{
  display:flex;
  width:100vw;
  height:100%;
}

/* ===== 左：コース ===== */
#left{
  width:50vw;
  position:relative;
  background:#0f5f2a url("assets/course.png") center/contain no-repeat;
}

#ballCanvas{
  position:absolute;
  inset:0;
}

/* 風 */
#windInfo{
  position:absolute;
  top:10px;
  left:10px;
  background:rgba(0,0,0,.5);
  color:white;
  padding:6px 10px;
  border-radius:8px;
  font-size:14px;
  z-index:10;
}

/* ★追加：ホール情報（四角い箱） */
#holeInfo{
  position:absolute;
  top:52px;         /* windInfoの下に配置 */
  left:10px;
  width:160px;
  background:rgba(0,0,0,.45);
  color:#fff;
  padding:10px 12px;
  border-radius:10px;
  font-size:14px;
  font-weight:800;
  z-index:10;
  border:1px solid rgba(255,255,255,.15);
}

/* NiceON表示 */
#banner{
  position:absolute;
  top:96px; /* holeInfoの下あたり */
  left:10px;
  right:10px;
  text-align:center;
  z-index:20;
  pointer-events:none;
  display:none;
}
#banner span{
  display:inline-block;
  background:rgba(0,0,0,.55);
  color:#fff;
  padding:10px 14px;
  border-radius:12px;
  font-weight:900;
  letter-spacing:.06em;
}

/* クラブ */
.club-buttons{
  position:absolute;
  bottom:70px;
  left:10px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  z-index:10;
}
.club-buttons button{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  font-size:14px;
}
.club-buttons button.active{
  outline:3px solid gold;
}

/* ===== 右 ===== */
#right{
  width:50vw;
  display:flex;
  flex-direction:column;
}

#impactZone{
  flex:1;
  background:#111;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
}
#ballUI{
  width:220px;
  height:220px;
  position:relative;
}

/* ゴルフボール */
#ballCircle{
  width:100%;
  height:100%;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%, white, #ddd);
  position:relative;
  overflow:hidden;
}
.dimple{
  position:absolute;
  width:8px;
  height:8px;
  border-radius:50%;
  background:rgba(0,0,0,.08);
}

/* ＋カーソル（クラブ選択後のみ表示） */
#impactCursor{
  position:absolute;
  width:40px;
  height:40px;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  display:none;
}
#impactCursor::before,
#impactCursor::after{
  content:"";
  position:absolute;
  background:black;
}
#impactCursor::before{
  width:6px;
  height:100%;
  left:50%;
  transform:translateX(-50%);
}
#impactCursor::after{
  height:6px;
  width:100%;
  top:50%;
  transform:translateY(-50%);
}

/* プレイヤー */
#playerZone{
  flex:1;
  background:linear-gradient(#2b8f44,#1f8f3a);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  overflow:hidden;
}
#golferImg{
  height:80%;
  object-fit:contain;
  transition:transform .3s;
}
.swing{
  transform:rotate(25deg);
}

/* ===== グリーンモード（仮） ===== */
#greenOverlay{
  position:fixed;
  inset:0;
  background:linear-gradient(#2f9e48,#177a36);
  display:none;
  z-index:200;
  color:#fff;
  padding:16px;
}
#greenOverlay h2{
  margin:0 0 10px 0;
  font-size:22px;
}
#backToCourse{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- オープニング -->
<div id="startScreen">
  <h1>REAL GOLF!</h1>
  <button id="startBtn">START</button>
</div>

<!-- グリーンモード（仮画面） -->
<div id="greenOverlay">
  <h2>GREEN MODE</h2>
  <p>（次はここに傾斜ライン＋パター操作を入れます）</p>
  <button id="backToCourse">コースに戻る</button>
</div>

<!-- ゲーム -->
<div id="layout" style="display:none;">

  <div id="left">
    <canvas id="ballCanvas"></canvas>
    <div id="windInfo"></div>

    <!-- ★追加：ホール情報 -->
    <div id="holeInfo">1H Par4:---</div>

    <div id="banner"><span>NiceON</span></div>

    <div class="club-buttons">
      <button data-power="220">1W</button>
      <button data-power="190">3W</button>
      <button data-power="160">5I</button>
      <button data-power="140">7I</button>
      <button data-power="110">9I</button>
      <button data-power="60">SW</button>
    </div>
  </div>

  <div id="right">
    <div id="impactZone">
      <div id="ballUI">
        <div id="ballCircle"></div>
        <div id="impactCursor"></div>
      </div>
    </div>

    <div id="playerZone">
      <img id="golferImg" src="assets/golfer.png" alt="golfer">
    </div>
  </div>

</div>

<script>
/* ===== iPhone Safariの100vh問題対策 ===== */
function setRealHeight(){
  document.body.style.height = window.innerHeight + "px";
}
window.addEventListener("resize", setRealHeight);
setRealHeight();

/* ===== スタート ===== */
document.getElementById("startBtn").onclick = ()=>{
  document.getElementById("startScreen").style.display="none";
  document.getElementById("layout").style.display="flex";
  setTimeout(()=>{ resize(); resetHole(); }, 50);
};

/* ===== グリーンモード（仮） ===== */
const greenOverlay = document.getElementById("greenOverlay");
document.getElementById("backToCourse").onclick = ()=>{
  greenOverlay.style.display="none";
};

/* ===== ディンプル生成 ===== */
const ballCircle = document.getElementById("ballCircle");
for(let i=0;i<90;i++){
  const d=document.createElement("div");
  d.className="dimple";
  d.style.left=Math.random()*100+"%";
  d.style.top=Math.random()*100+"%";
  ballCircle.appendChild(d);
}

/* ===== 左canvas ===== */
const canvas = document.getElementById("ballCanvas");
const ctx = canvas.getContext("2d");

/* ---- 風 ---- */
let windSpeed = Math.random()*2;
let windDir = Math.random()*360;

function updateWindUI(){
  document.getElementById("windInfo").innerText =
    `風向:${Math.floor(windDir)}° 風速:${windSpeed.toFixed(1)}m`;
}
updateWindUI();

/* ---- 位置設定 ---- */
function getTeePos(){
  return { x: canvas.width*0.62, y: canvas.height*0.88 };
}
function getGreenCenter(){
  return { x: canvas.width*0.62, y: canvas.height*0.12 };
}
function getGreenRadius(){
  return Math.min(canvas.width, canvas.height) * 0.07;
}

/* ---- 距離表示（XXX） ----
   ここでは「残り距離」を yd 表示にします。
   コース画像は縮尺がないので、画面上の距離を “ホール想定長(360yd)” に当てはめます。
*/
const HOLE_YARDS = 360; // Par4想定
function remainingYards(){
  const g = getGreenCenter();
  const d = Math.hypot(ball.x - g.x, ball.y - g.y);

  // 画面上の「ティー→グリーン」の距離をホール長にマッピング
  const tee = getTeePos();
  const base = Math.hypot(tee.x - g.x, tee.y - g.y) || 1;

  const yards = Math.max(0, Math.round((d / base) * HOLE_YARDS));
  return yards;
}

function updateHoleInfo(){
  const y = remainingYards();
  document.getElementById("holeInfo").innerText = `1H Par4:${y}yd`;
}

/* ---- 状態 ---- */
let stroke = 0;
let clubPower = 0;
let ball = { x: 0, y: 0 };
let velocity = { x: 0, y: 0 };
let isBallMoving = false;

let phase = "idle";
let cursorY = 0;
let cursorX = 0;
let direction = 1;

function resize(){
  canvas.width = canvas.parentElement.clientWidth;
  canvas.height = canvas.parentElement.clientHeight;
}
window.addEventListener("resize", ()=>{ resize(); draw(); });
resize();

function resetHole(){
  stroke = 0;
  clubPower = 0;
  phase = "idle";
  isBallMoving = false;
  velocity.x = velocity.y = 0;

  const tee = getTeePos();
  ball.x = tee.x;
  ball.y = tee.y;

  document.getElementById("impactCursor").style.display = "none";
  updateHoleInfo();
  draw();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, 6, 0, Math.PI*2);
  ctx.fill();

  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.font="12px sans-serif";
  ctx.fillText(`Stroke: ${stroke}`, 10, canvas.height-10);
}

/* ===== ボール移動：停止→距離更新→ON判定 ===== */
function animate(){
  if(isBallMoving){
    velocity.x += Math.cos(windDir*Math.PI/180) * windSpeed * 0.008;

    ball.x += velocity.x;
    ball.y += velocity.y;

    velocity.x *= 0.985;
    velocity.y *= 0.985;

    if(Math.hypot(velocity.x, velocity.y) < 0.06){
      isBallMoving = false;
      velocity.x = 0;
      velocity.y = 0;

      if(isOnGreen()){
        showNiceOnAndSwitch();
      }
    }
  }

  updateHoleInfo();
  draw();
  requestAnimationFrame(animate);
}
animate();

function isOnGreen(){
  const g = getGreenCenter();
  const r = getGreenRadius();
  return Math.hypot(ball.x - g.x, ball.y - g.y) <= r;
}

function showNiceOnAndSwitch(){
  const banner = document.getElementById("banner");
  banner.style.display = "block";

  setTimeout(()=>{
    banner.style.display = "none";
    greenOverlay.style.display = "block";
  }, 1000);
}

/* ===== クラブ ===== */
document.querySelectorAll(".club-buttons button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".club-buttons button")
      .forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    clubPower = Number(btn.dataset.power);

    phase = "vertical";
    cursorX = 0;
    cursorY = 0;
    direction = 1;

    const cursor = document.getElementById("impactCursor");
    cursor.style.display = "block";
    cursor.style.left = "50%";
    cursor.style.top  = "50%";
  };
});

/* ===== カーソル移動 ===== */
function moveCursor(){
  const cursor = document.getElementById("impactCursor");

  if(phase==="vertical"){
    cursorY += direction*2;
    if(cursorY>50 || cursorY<-50) direction*=-1;
    cursor.style.top = (50 + cursorY) + "%";
    cursor.style.left = "50%";
  }else if(phase==="horizontal"){
    cursorX += direction*2;
    if(cursorX>50 || cursorX<-50) direction*=-1;
    cursor.style.left = (50 + cursorX) + "%";
    cursor.style.top  = "50%";
  }else{
    cursor.style.left = "50%";
    cursor.style.top  = "50%";
  }
  requestAnimationFrame(moveCursor);
}
moveCursor();

/* ===== タップ順 ===== */
document.getElementById("impactZone").addEventListener("click",()=>{
  if(clubPower<=0) return;
  if(isBallMoving) return;

  if(phase==="vertical"){
    phase="horizontal";
    direction=1;
  }else if(phase==="horizontal"){
    phase="done";
    swingAndShot();
  }
});

function swingAndShot(){
  const golfer=document.getElementById("golferImg");
  golfer.classList.add("swing");
  setTimeout(()=>golfer.classList.remove("swing"),300);

  stroke += 1;

  const g = getGreenCenter();
  const dx = g.x - ball.x;
  const dy = g.y - ball.y;
  const len = Math.hypot(dx,dy) || 1;
  const nx = dx / len;
  const ny = dy / len;

  const forwardScale = 1 + (-cursorY * 0.004);
  const sideScale    = (cursorX * 0.010);

  const speed = clubPower * 0.03;
  const px = -ny;
  const py = nx;

  velocity.x = nx * speed * forwardScale + px * speed * sideScale;
  velocity.y = ny * speed * forwardScale + py * speed * sideScale;

  isBallMoving = true;

  setTimeout(()=>{
    phase="idle";
    document.getElementById("impactCursor").style.display="none";
    cursorX=0; cursorY=0;
  }, 650);
}
</script>

</body>
</html>
