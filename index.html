<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Real Golf</title>

<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  font-family:sans-serif;
  padding-bottom: env(safe-area-inset-bottom);
}

/* ===== オープニング ===== */
#startScreen{
  position:fixed;
  inset:0;
  background:url("https://images.unsplash.com/photo-1592919505780-303950717480?q=80&w=1600") center/cover;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  color:white;
  z-index:100;
}
#startScreen h1{
  font-size:48px;
  text-shadow:0 4px 20px rgba(0,0,0,.6);
}
#startBtn{
  padding:12px 24px;
  border:none;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
}

/* ===== ゲーム画面 ===== */
#layout{
  display:flex;
  width:100vw;
  height:100%;
}

/* ===== 左：コース（背景に画像） ===== */
#left{
  width:50vw;
  position:relative;
  /* ★コース画像を左エリアに表示（縦長を収める） */
  background:#0f5f2a url("assets/course.png") center/contain no-repeat;
}

/* ボール描画用（透明のまま上に乗せる） */
#ballCanvas{
  position:absolute;
  inset:0;
}

#windInfo{
  position:absolute;
  top:10px;
  left:10px;
  background:rgba(0,0,0,.5);
  color:white;
  padding:6px 10px;
  border-radius:8px;
  font-size:14px;
  z-index:10;
}

/* クラブ */
.club-buttons{
  position:absolute;
  bottom:70px; /* iPhoneでも見切れにくい */
  left:10px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  z-index:10;
}
.club-buttons button{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  font-size:14px;
}
.club-buttons button.active{
  outline:3px solid gold;
}

/* ===== 右 ===== */
#right{
  width:50vw;
  display:flex;
  flex-direction:column;
}

/* ===== ボールUI ===== */
#impactZone{
  flex:1;
  background:#111;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
}
#ballUI{
  width:220px;
  height:220px;
  position:relative;
}

/* ゴルフボール */
#ballCircle{
  width:100%;
  height:100%;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%, white, #ddd);
  position:relative;
  overflow:hidden;
}
/* ディンプル */
.dimple{
  position:absolute;
  width:8px;
  height:8px;
  border-radius:50%;
  background:rgba(0,0,0,.08);
}

/* ＋カーソル（クラブ選択後のみ表示） */
#impactCursor{
  position:absolute;
  width:40px;
  height:40px;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  display:none;
}
#impactCursor::before,
#impactCursor::after{
  content:"";
  position:absolute;
  background:black;
}
#impactCursor::before{
  width:6px;
  height:100%;
  left:50%;
  transform:translateX(-50%);
}
#impactCursor::after{
  height:6px;
  width:100%;
  top:50%;
  transform:translateY(-50%);
}

/* ===== プレイヤー ===== */
#playerZone{
  flex:1;
  background:linear-gradient(#2b8f44,#1f8f3a);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  overflow:hidden;
}
#golferImg{
  height:80%;
  object-fit:contain;
  transition:transform .3s;
}
.swing{
  transform:rotate(25deg);
}
</style>
</head>

<body>

<!-- オープニング -->
<div id="startScreen">
  <h1>REAL GOLF!</h1>
  <button id="startBtn">START</button>
</div>

<!-- ゲーム -->
<div id="layout" style="display:none;">

  <!-- 左 -->
  <div id="left">
    <canvas id="ballCanvas"></canvas>
    <div id="windInfo"></div>

    <div class="club-buttons">
      <button data-power="220">1W</button>
      <button data-power="190">3W</button>
      <button data-power="160">5I</button>
      <button data-power="140">7I</button>
      <button data-power="110">9I</button>
      <button data-power="60">SW</button>
    </div>
  </div>

  <!-- 右 -->
  <div id="right">
    <div id="impactZone">
      <div id="ballUI">
        <div id="ballCircle"></div>
        <div id="impactCursor"></div>
      </div>
    </div>

    <div id="playerZone">
      <img id="golferImg" src="assets/golfer.png" alt="golfer">
    </div>
  </div>

</div>

<script>
/* ===== iPhone Safariの100vh問題対策 ===== */
function setRealHeight(){
  document.body.style.height = window.innerHeight + "px";
}
window.addEventListener("resize", setRealHeight);
setRealHeight();

/* ===== スタート ===== */
document.getElementById("startBtn").onclick = ()=>{
  document.getElementById("startScreen").style.display="none";
  document.getElementById("layout").style.display="flex";
  setTimeout(()=>{ resize(); draw(); }, 50);
};

/* ===== ディンプル生成 ===== */
const ballCircle = document.getElementById("ballCircle");
for(let i=0;i<90;i++){
  const d=document.createElement("div");
  d.className="dimple";
  d.style.left=Math.random()*100+"%";
  d.style.top=Math.random()*100+"%";
  ballCircle.appendChild(d);
}

/* ===== ゲーム（左canvasはボールだけ描く） ===== */
const canvas = document.getElementById("ballCanvas");
const ctx = canvas.getContext("2d");

let clubPower = 0;            // 未選択は0（重要）
let windSpeed = Math.random()*2;
let windDir = Math.random()*360;

document.getElementById("windInfo").innerText =
  `風向:${Math.floor(windDir)}° 風速:${windSpeed.toFixed(1)}m`;

/**
 * ティーとグリーンの位置（canvasに対する割合で設定）
 * 画像が contain で表示されるので、”だいたい”の位置を割合で決めるのが安定。
 * 必要ならここだけ微調整してOK。
 */
function getTeePos(){
  return { x: canvas.width*0.55, y: canvas.height*0.88 }; // 下寄り
}
function getGreenPos(){
  return { x: canvas.width*0.62, y: canvas.height*0.12 }; // 上寄り
}

let ball = { x: 0, y: 0 };
let velocity = { x: 0, y: 0 };
let isBallMoving = false;

let phase = "idle"; // idle -> vertical -> horizontal -> done
let cursorY = 0;
let cursorX = 0;
let direction = 1;

function resize(){
  canvas.width = canvas.parentElement.clientWidth;
  canvas.height = canvas.parentElement.clientHeight;

  // 初期位置はティーに置く
  const tee = getTeePos();
  if(!isBallMoving){
    ball.x = tee.x;
    ball.y = tee.y;
  }
}
window.addEventListener("resize", resize);
resize();

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // ボールだけ描画（背景はCSSのコース画像）
  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, 6, 0, Math.PI*2);
  ctx.fill();
}

function animate(){
  if(isBallMoving){
    // 風はx方向にほんの少し
    velocity.x += Math.cos(windDir*Math.PI/180) * windSpeed * 0.01;

    // 更新
    ball.x += velocity.x;
    ball.y += velocity.y;

    // 摩擦（減速）
    velocity.x *= 0.985;
    velocity.y *= 0.985;

    // ほぼ止まったら終了
    if(Math.hypot(velocity.x, velocity.y) < 0.05){
      isBallMoving = false;
      velocity.x = 0;
      velocity.y = 0;
    }
  }

  draw();
  requestAnimationFrame(animate);
}
animate();

/* ===== クラブ選択（選択後だけカーソル作動） ===== */
document.querySelectorAll(".club-buttons button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".club-buttons button")
      .forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    clubPower = Number(btn.dataset.power);

    // クラブ選択が終わったら、操作フェーズ開始
    phase = "vertical";
    cursorX = 0;
    cursorY = 0;
    direction = 1;

    const cursor = document.getElementById("impactCursor");
    cursor.style.display = "block";
    cursor.style.left = "50%";
    cursor.style.top  = "50%";
  };
});

/* ===== カーソル移動（phaseがvertical/horizontalの時だけ動く） ===== */
function moveCursor(){
  const cursor = document.getElementById("impactCursor");

  if(phase==="vertical"){
    cursorY += direction*2;
    if(cursorY>50 || cursorY<-50) direction*=-1;
    cursor.style.top = (50 + cursorY) + "%";
    cursor.style.left = "50%";
  }else if(phase==="horizontal"){
    cursorX += direction*2;
    if(cursorX>50 || cursorX<-50) direction*=-1;
    cursor.style.left = (50 + cursorX) + "%";
    cursor.style.top  = "50%";
  }else{
    // idle/done は中心固定（クラブ未選択時もここ）
    cursor.style.left = "50%";
    cursor.style.top  = "50%";
  }

  requestAnimationFrame(moveCursor);
}
moveCursor();

/* ===== タップ順：上下固定 → 左右固定 → スイング → ボール移動 ===== */
document.getElementById("impactZone").addEventListener("click",()=>{
  // クラブ未選択は何もしない（中心固定）
  if(clubPower<=0) return;

  if(phase==="vertical"){
    phase="horizontal";
    direction=1;
  }else if(phase==="horizontal"){
    phase="done";
    swingAndShot();
  }
});

function swingAndShot(){
  // スイング
  const golfer=document.getElementById("golferImg");
  golfer.classList.add("swing");
  setTimeout(()=>golfer.classList.remove("swing"),300);

  // ティー→グリーン方向の基準ベクトル
  const tee = getTeePos();
  const green = getGreenPos();
  const dx = green.x - tee.x;
  const dy = green.y - tee.y;
  const len = Math.hypot(dx,dy) || 1;

  // 基準方向（グリーンへ向かう）
  const nx = dx / len;
  const ny = dy / len;

  // インパクト反映（ざっくり）
  // cursorY: 上(マイナス)＝トップっぽい → 飛ぶ(前進増)
  //         下(プラス)＝ダフリっぽい → 飛ばない(前進減)
  const forwardScale = 1 + (-cursorY * 0.004); // -50..50 => 1.2..0.8 くらい
  const sideScale    = (cursorX * 0.010);      // -50..50 => -0.5..0.5 くらい（横ズレ）

  // ショットの強さ（クラブpowerを速度に）
  const speed = clubPower * 0.03;

  // 方向ベクトルに「横ズレ」を加える（直交方向）
  const px = -ny; // 90度回転（右方向）
  const py = nx;

  velocity.x = nx * speed * forwardScale + px * speed * sideScale;
  velocity.y = ny * speed * forwardScale + py * speed * sideScale;

  // ボールをティーに置いてスタート
  ball.x = tee.x;
  ball.y = tee.y;
  isBallMoving = true;

  // 一連終了 → 次のショットはクラブ再選択からにするなら clubPower=0 にする
  // 今回は「次も同クラブで打てる」方が遊びやすいので clubPower は維持
  setTimeout(()=>{
    phase="idle";
    document.getElementById("impactCursor").style.display="none";
    cursorX=0; cursorY=0;
  }, 700);
}
</script>

</body>
</html>
