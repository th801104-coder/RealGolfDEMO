<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Real Golf</title>

<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  font-family:sans-serif;
}

/* ===== レイアウト ===== */
#layout{
  display:flex;
  width:100vw;
  height:100vh;
}

#left{
  width:50vw;
  position:relative;
  background:#0f5f2a url("assets/course.png") center/contain no-repeat;
  touch-action: pan-y;
}
#ballCanvas{
  position:absolute;
  inset:0;
}

#right{
  width:50vw;
  display:flex;
  flex-direction:column;
}
#impactZone{
  flex:1;
  background:#111;
  display:flex;
  justify-content:center;
  align-items:center;
}
#playerZone{
  flex:1;
  background:linear-gradient(#2b8f44,#1f8f3a);
  display:flex;
  justify-content:center;
  align-items:flex-end;
}
#golferImg{
  height:80%;
  transition:transform .3s;
}
.swing{ transform:rotate(25deg); }

/* ===== GREEN MODE ===== */
#greenOverlay{
  position:fixed;
  inset:0;
  display:none;
  z-index:200;
}
#greenCanvas{
  position:absolute;
  inset:0;
}
#powerBar{
  position:absolute;
  left:20px;
  right:20px;
  bottom:30px;
  height:14px;
  background:#444;
  border-radius:999px;
}
#powerFill{
  position:absolute;
  left:0;
  top:0;
  bottom:0;
  width:0%;
  background:#fff;
  border-radius:999px;
}
</style>
</head>
<body>

<div id="layout">
  <div id="left">
    <canvas id="ballCanvas"></canvas>
  </div>

  <div id="right">
    <div id="impactZone">
      <div id="ballUI"></div>
    </div>
    <div id="playerZone">
      <img id="golferImg" src="assets/golfer.png">
    </div>
  </div>
</div>

<div id="greenOverlay">
  <canvas id="greenCanvas"></canvas>
  <div id="powerBar"><div id="powerFill"></div></div>
</div>

<script>

/* =========================
   COURSE 部分（簡略）
========================= */

const canvas = document.getElementById("ballCanvas");
const ctx = canvas.getContext("2d");
canvas.width = canvas.parentElement.clientWidth;
canvas.height = canvas.parentElement.clientHeight;

let ball = {x:canvas.width*0.4,y:canvas.height*0.8};
let velocity = {x:0,y:0};
let moving = false;

function drawCourse(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.arc(ball.x,ball.y,6,0,Math.PI*2);
  ctx.fill();
}
drawCourse();

function enterGreen(){
  document.getElementById("greenOverlay").style.display="block";
  initGreen();
}

/* =========================
   GREEN MODE
========================= */

const greenCanvas = document.getElementById("greenCanvas");
const gctx = greenCanvas.getContext("2d");
greenCanvas.width = window.innerWidth;
greenCanvas.height = window.innerHeight;

let gBall={x:0,y:0};
let gVel={x:0,y:0};
let gCup={x:0,y:0,r:12};
let gSlope={ax:0,ay:0};
let powerT=0;
let powerDir=1;
let gMoving=false;

/* ===== パター音 ===== */
function playPuttSound(){
  const ctxA = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctxA.createOscillator();
  const gain = ctxA.createGain();
  osc.type="triangle";
  osc.frequency.value=600;
  gain.gain.setValueAtTime(0.2,ctxA.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,ctxA.currentTime+0.15);
  osc.connect(gain);
  gain.connect(ctxA.destination);
  osc.start();
  osc.stop(ctxA.currentTime+0.15);
}

/* ===== 初期化 ===== */
function initGreen(){
  const cx=greenCanvas.width*0.5;
  const cy=greenCanvas.height*0.6;
  gBall.x=cx;
  gBall.y=cy;

  gCup.x=cx;
  gCup.y=greenCanvas.height*0.35;

  // 傾斜弱化
  const dir=Math.random()*Math.PI*2;
  const strength=0.006+Math.random()*0.006;
  gSlope.ax=Math.cos(dir)*strength;
  gSlope.ay=Math.sin(dir)*strength;

  powerT=0.2;
  gMoving=false;
  drawGreen();
}

/* ===== 描画 ===== */
function drawGreen(){
  gctx.clearRect(0,0,greenCanvas.width,greenCanvas.height);

  // ラフ背景
  gctx.fillStyle="#1c5f36";
  gctx.fillRect(0,0,greenCanvas.width,greenCanvas.height);

  // 楕円グリーン
  const cx=greenCanvas.width*0.5;
  const cy=greenCanvas.height*0.5;
  const rx=greenCanvas.width*0.35;
  const ry=greenCanvas.height*0.25;

  gctx.save();
  gctx.beginPath();
  gctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);
  gctx.clip();

  const grad=gctx.createRadialGradient(cx,cy,10,cx,cy,rx);
  grad.addColorStop(0,"#6fffa0");
  grad.addColorStop(1,"#1d9b52");
  gctx.fillStyle=grad;
  gctx.fillRect(cx-rx,cy-ry,rx*2,ry*2);

  // カップ
  gctx.fillStyle="black";
  gctx.beginPath();
  gctx.arc(gCup.x,gCup.y,gCup.r,0,Math.PI*2);
  gctx.fill();

  // ボール
  gctx.fillStyle="white";
  gctx.beginPath();
  gctx.arc(gBall.x,gBall.y,9,0,Math.PI*2);
  gctx.fill();

  gctx.restore();
}

/* ===== パット ===== */
function putt(){
  playPuttSound();

  const speed=6*(0.2+powerT*0.8);
  const angle=-Math.PI/2;

  gVel.x=Math.cos(angle)*speed;
  gVel.y=Math.sin(angle)*speed;
  gMoving=true;
}

/* ===== 物理 ===== */
function animateGreen(){
  if(gMoving){
    gVel.x+=gSlope.ax;
    gVel.y+=gSlope.ay;

    gBall.x+=gVel.x;
    gBall.y+=gVel.y;

    const FRICTION=0.982;
    gVel.x*=FRICTION;
    gVel.y*=FRICTION;

    // 楕円外制御
    const cx=greenCanvas.width*0.5;
    const cy=greenCanvas.height*0.5;
    const rx=greenCanvas.width*0.35;
    const ry=greenCanvas.height*0.25;

    const dx=(gBall.x-cx)/rx;
    const dy=(gBall.y-cy)/ry;
    if(dx*dx+dy*dy>1){
      gBall.x-=gVel.x;
      gBall.y-=gVel.y;
      gVel.x*=-0.2;
      gVel.y*=-0.2;
    }

    if(Math.hypot(gVel.x,gVel.y)<0.2){
      gMoving=false;
    }
  }

  // パワー往復
  powerT+=powerDir*0.02;
  if(powerT>1){powerT=1;powerDir=-1;}
  if(powerT<0){powerT=0;powerDir=1;}
  document.getElementById("powerFill").style.width=(powerT*100)+"%";

  drawGreen();
  requestAnimationFrame(animateGreen);
}
animateGreen();

/* タップでパット */
document.getElementById("greenOverlay").addEventListener("click",()=>{
  if(!gMoving) putt();
});

/* デモ用：クリックでグリーンへ */
canvas.addEventListener("click",enterGreen);

</script>
</body>
</html>
