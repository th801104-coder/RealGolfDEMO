<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Real Golf</title>

<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  font-family:sans-serif;
  padding-bottom: env(safe-area-inset-bottom);
}

/* ===== オープニング ===== */
#startScreen{
  position:fixed;
  inset:0;
  background:url("https://images.unsplash.com/photo-1592919505780-303950717480?q=80&w=1600") center/cover;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  color:white;
  z-index:100;
}
#startScreen h1{
  font-size:48px;
  text-shadow:0 4px 20px rgba(0,0,0,.6);
}
#startBtn{
  padding:12px 24px;
  border:none;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
}

/* ===== ゲーム画面 ===== */
#layout{
  display:flex;
  width:100vw;
  height:100%;
}

/* ===== 左：コース ===== */
#left{
  width:50vw;
  position:relative;
  background:#0f5f2a url("assets/course.png") center/contain no-repeat;
  touch-action: pan-y; /* 横スワイプを拾いつつ、縦スクロールは許可 */
}
#ballCanvas{
  position:absolute;
  inset:0;
}

/* 上から：1H -> 風 */
#holeInfo{
  position:absolute;
  top:10px;
  left:10px;
  width:200px;
  background:rgba(0,0,0,.45);
  color:#fff;
  padding:10px 12px;
  border-radius:10px;
  font-size:14px;
  font-weight:900;
  z-index:10;
  border:1px solid rgba(255,255,255,.15);
  line-height:1.25;
}

/* 風（矢印＋風速） */
#windInfo{
  position:absolute;
  top:72px;
  left:10px;
  background:rgba(0,0,0,.5);
  color:white;
  padding:8px 10px;
  border-radius:8px;
  font-size:14px;
  z-index:10;
  display:flex;
  align-items:center;
  gap:8px;
}
#windArrow{
  width:22px;
  height:22px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  line-height:1;
  transform-origin:center;
  filter: drop-shadow(0 1px 0 rgba(0,0,0,.6));
}
#windSpeedText{ font-weight:900; }

/* NiceON表示 */
#banner{
  position:absolute;
  top:118px;
  left:10px;
  right:10px;
  text-align:center;
  z-index:20;
  pointer-events:none;
  display:none;
}
#banner span{
  display:inline-block;
  background:rgba(0,0,0,.55);
  color:#fff;
  padding:10px 14px;
  border-radius:12px;
  font-weight:900;
  letter-spacing:.06em;
}

/* クラブ */
.club-buttons{
  position:absolute;
  bottom:20px;
  left:10px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  z-index:10;
}
.club-buttons button{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  font-size:14px;
}
.club-buttons button.active{ outline:3px solid gold; }

/* ===== 右 ===== */
#right{
  width:50vw;
  display:flex;
  flex-direction:column;
}
#impactZone{
  flex:1;
  background:#111;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
}
#ballUI{
  width:220px;
  height:220px;
  position:relative;
}
/* 右上のゴルフボール（画像差し替え版） */
#ballCircle{
  width:100%;
  height:100%;
  border-radius:50%;
  background: url("assets/golfball.jpg") center/cover no-repeat;
  position:relative;
  overflow:hidden;
  box-shadow: inset 0 6px 16px rgba(255,255,255,.35),
              inset 0 -10px 18px rgba(0,0,0,.25);
}
/* ＋カーソル（クラブ選択後のみ表示） */
#impactCursor{
  position:absolute;
  width:40px;
  height:40px;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  display:none;
}
#impactCursor::before,
#impactCursor::after{
  content:"";
  position:absolute;
  background:black;
}
#impactCursor::before{
  width:6px;
  height:100%;
  left:50%;
  transform:translateX(-50%);
}
#impactCursor::after{
  height:6px;
  width:100%;
  top:50%;
  transform:translateY(-50%);
}

/* プレイヤー */
#playerZone{
  flex:1;
  background:linear-gradient(#2b8f44,#1f8f3a);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  overflow:hidden;
}
#golferImg{
  height:80%;
  width:auto;
  object-fit:contain;
  object-position:bottom center;
  image-rendering:auto;
}

/* ===== GREEN MODE ===== */
#greenOverlay{
  position:fixed;
  inset:0;
  display:none;
  z-index:200;
  color:#fff;
}
/* グリーン背景（キャンバスで黒背景描画するが、念のため） */
#greenStage{
  position:absolute;
  inset:0;
  background:#000;
  overflow:hidden;
}
#greenCanvas{
  position:absolute;
  inset:0;
}

/* HUD */
#greenHUD{
  position:absolute;
  top:12px;
  left:12px;
  right:12px;
  display:flex;
  gap:10px;
  align-items:stretch;
  justify-content:space-between;
  pointer-events:none;
}
.hudCard{
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.14);
  border-radius:12px;
  padding:10px 12px;
  font-weight:900;
  line-height:1.2;
  pointer-events:none;
}
#greenTitle{ min-width:150px; }
#greenInfo{ flex:1; text-align:center; }
#greenHint{ min-width:190px; text-align:right; }

/* 強さゲージ */
#powerWrap{
  position:absolute;
  left:16px;
  right:16px;
  bottom:18px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:12px;
}
#powerRow{
  display:flex;
  align-items:center;
  gap:12px;
}
#powerLabel{ font-weight:900; white-space:nowrap; }
#powerBar{
  position:relative;
  height:14px;
  flex:1;
  background:rgba(255,255,255,.18);
  border-radius:999px;
  overflow:hidden;
}
#powerFill{
  position:absolute;
  left:0; top:0; bottom:0;
  width:0%;
  background:rgba(255,255,255,.75);
}
#powerMarker{
  position:absolute;
  top:-4px;
  width:4px;
  height:22px;
  left:0%;
  background:rgba(255, 215, 0, .95);
  border-radius:999px;
  box-shadow:0 1px 0 rgba(0,0,0,.35);
}
#greenButtons{
  margin-top:10px;
  display:flex;
  gap:8px;
  justify-content:flex-end;
}
#greenButtons button{
  pointer-events:auto;
  padding:10px 12px;
  border:none;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
}

/* HOLE OUT */
#holeOutBanner{
  position:absolute;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  text-align:center;
  background:rgba(0,0,0,.55);
}
#holeOutBanner .inner{
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.16);
  border-radius:16px;
  padding:16px 18px;
  max-width:min(520px, 90vw);
}
#holeOutBanner h2{
  margin:0 0 8px 0;
  font-size:28px;
  letter-spacing:.06em;
}
#holeOutBanner p{
  margin:0 0 12px 0;
  opacity:.95;
  font-weight:800;
}
#holeOutBanner button{
  padding:12px 14px;
  border:none;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
  margin:0 6px;
}
</style>
</head>

<body>

<!-- オープニング -->
<div id="startScreen">
  <h1>REAL GOLF!</h1>
  <button id="startBtn">START</button>
</div>

<!-- GREEN MODE -->
<div id="greenOverlay">
  <div id="greenStage">
    <canvas id="greenCanvas"></canvas>

    <div id="greenHUD">
      <div class="hudCard" id="greenTitle">GREEN MODE</div>
      <div class="hudCard" id="greenInfo">Hole 1 Par4<br>Strokes: 0<br>Dist: -- ft / Slope: --</div>
      <div class="hudCard" id="greenHint">Swipe L/R: Aim<br>Tap: Putt</div>
    </div>

    <div id="powerWrap">
      <div id="powerRow">
        <div id="powerLabel">POWER</div>
        <div id="powerBar">
          <div id="powerFill"></div>
          <div id="powerMarker"></div>
        </div>
      </div>
      <div id="greenButtons">
        <button id="backToCourse">コースに戻る</button>
      </div>
    </div>

    <div id="holeOutBanner">
      <div class="inner">
        <h2>HOLE OUT!</h2>
        <p id="holeOutText">Great putt!</p>
        <div>
          <button id="nextHoleBtn">次ホール（簡易）</button>
          <button id="stayBtn">コースに戻る</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ゲーム -->
<div id="layout" style="display:none;">

  <div id="left">
    <canvas id="ballCanvas"></canvas>

    <div id="holeInfo">1H Par4<br>Rest360 First</div>

    <div id="windInfo">
      <span id="windArrow">↑</span>
      <span id="windSpeedText">0.0m</span>
    </div>

    <div id="banner"><span>NiceON</span></div>

    <div class="club-buttons">
      <button data-power="220">1W</button>
      <button data-power="190">3W</button>
      <button data-power="160">5I</button>
      <button data-power="140">7I</button>
      <button data-power="110">9I</button>
      <button data-power="60">SW</button>
    </div>
  </div>

  <div id="right">
    <div id="impactZone">
      <div id="ballUI">
        <div id="ballCircle"></div>
        <div id="impactCursor"></div>
      </div>
    </div>

    <div id="playerZone">
      <!-- ★ 5枚コマ送り用：初期表示はJSで入れます -->
      <img id="golferImg" src="assets/golfer_1.png" alt="golfer">
    </div>
  </div>

</div>

<script>
/* ===== iPhone Safariの100vh問題対策 ===== */
function setRealHeight(){
  document.body.style.height = window.innerHeight + "px";
}
window.addEventListener("resize", setRealHeight);
setRealHeight();

/* ===== スタート ===== */
document.getElementById("startBtn").onclick = ()=>{
  document.getElementById("startScreen").style.display="none";
  document.getElementById("layout").style.display="flex";
  setTimeout(()=>{ resizeCourse(); resetHole(); }, 50);
};

/* ===== ゴルファー：コマ送り（5枚） ===== */
const golferImg = document.getElementById("golferImg");

const SWING_FRAMES = [
  "assets/golfer_1.png",
  "assets/golfer_2.png",
  "assets/golfer_3.png",
  "assets/golfer_4.png",
  "assets/golfer_5.png"
];

// 先読み（ちらつき防止）
SWING_FRAMES.forEach(src => { const im = new Image(); im.src = src; });

// 初期は1枚目
golferImg.src = SWING_FRAMES[0];

let swingAnimTimer = null;

function playSwingAnimation(){
  if(swingAnimTimer) clearInterval(swingAnimTimer);

  let i = 0;
  golferImg.src = SWING_FRAMES[i];

  // 速さ（ms） ※テンポ調整ポイント
  const frameMs = 90;

  swingAnimTimer = setInterval(()=>{
    i++;
    if(i >= SWING_FRAMES.length){
      clearInterval(swingAnimTimer);
      swingAnimTimer = null;
      golferImg.src = SWING_FRAMES[0];
      return;
    }
    golferImg.src = SWING_FRAMES[i];
  }, frameMs);
}

/* =========================
   COURSE (左)
========================= */
const leftEl = document.getElementById("left");
const impactZone = document.getElementById("impactZone");
const courseCanvas = document.getElementById("ballCanvas");
const courseCtx = courseCanvas.getContext("2d");

/* ---- 風 ----
   windDirDeg: 0°=右, 90°=下, 180°=左, 270°=上（canvas座標系）
*/
let windSpeed = 0.8 + Math.random()*2.2;
let windDirDeg = Math.random()*360;

function updateWindUI(){
  const arrow = document.getElementById("windArrow");
  arrow.style.transform = `rotate(${windDirDeg - 90}deg)`; // ↑を回す
  document.getElementById("windSpeedText").textContent = `${windSpeed.toFixed(1)}m`;
}
updateWindUI();

/* ---- ティー＆グリーン（だいたい） ---- */
const TEE_X_RATIO   = 0.38;
const TEE_Y_RATIO   = 0.78;

const GREEN_X_RATIO = 0.33;
const GREEN_Y_RATIO = 0.24;
const GREEN_RADIUS_RATIO = 0.10;

function getTeePos(){
  return { x: courseCanvas.width*TEE_X_RATIO, y: courseCanvas.height*TEE_Y_RATIO };
}
function getGreenCenter(){
  return { x: courseCanvas.width*GREEN_X_RATIO, y: courseCanvas.height*GREEN_Y_RATIO };
}
function getGreenRadius(){
  return Math.min(courseCanvas.width, courseCanvas.height) * GREEN_RADIUS_RATIO;
}

/* ---- 距離 ---- */
const HOLE_YARDS = 360;
function remainingYards(){
  const g = getGreenCenter();
  const d = Math.hypot(courseBall.x - g.x, courseBall.y - g.y);

  const tee = getTeePos();
  const base = Math.hypot(tee.x - g.x, tee.y - g.y) || 1;

  return Math.max(0, Math.round((d / base) * HOLE_YARDS));
}

/* ---- 打数（先頭大文字） ---- */
const ORDINALS = [
  "first","second","third","fourth","fifth",
  "sixth","seventh","eighth","ninth","tenth",
  "eleventh","twelfth","thirteenth","fourteenth","fifteenth"
];
function cap1(s){ return s ? (s[0].toUpperCase()+s.slice(1)) : s; }
function nextStrokeWord(){
  const n = stroke + 1;
  return cap1(ORDINALS[n-1] || (n + "th"));
}
function updateHoleInfo(){
  const y = remainingYards();
  document.getElementById("holeInfo").innerHTML =
    `1H Par4<br>Rest${y} ${nextStrokeWord()}`;
}

/* ---- スワイプでエイム（-2..+2） ---- */
let aimLevel = 0;
const AIM_MIN = -2;
const AIM_MAX =  2;
const AIM_STEP_DEG = 7;
const SWIPE_STEP_PX = 40;

let swipeActive = false;
let swipeStartX = 0;
let swipeAccumX = 0;

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

leftEl.addEventListener("pointerdown", (e)=>{
  if(inGreenMode) return;
  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  if(tag === "button") return;

  swipeActive = true;
  swipeStartX = e.clientX;
  swipeAccumX = 0;
  leftEl.setPointerCapture?.(e.pointerId);
});

leftEl.addEventListener("pointermove", (e)=>{
  if(inGreenMode) return;
  if(!swipeActive) return;
  if(isCourseBallMoving) return;

  const dx = e.clientX - swipeStartX;
  const delta = dx - swipeAccumX;

  if(Math.abs(delta) >= SWIPE_STEP_PX){
    const steps = Math.trunc(delta / SWIPE_STEP_PX);
    swipeAccumX += steps * SWIPE_STEP_PX;

    aimLevel = clamp(aimLevel + steps, AIM_MIN, AIM_MAX);
    drawCourse();
  }
});

function endSwipe(e){
  if(!swipeActive) return;
  swipeActive = false;
  swipeStartX = 0;
  swipeAccumX = 0;
  leftEl.releasePointerCapture?.(e.pointerId);
}
leftEl.addEventListener("pointerup", endSwipe);
leftEl.addEventListener("pointercancel", endSwipe);

/* ---- コース状態 ---- */
let stroke = 0;
let clubPower = 0;

let courseBall = { x: 0, y: 0 };
let courseVel  = { x: 0, y: 0 };
let isCourseBallMoving = false;

let phase = "idle";
let cursorY = 0;
let cursorX = 0;
let direction = 1;

let flightFrame = 0;
let flightFramesTotal = 0;

function resizeCourse(){
  courseCanvas.width = courseCanvas.parentElement.clientWidth;
  courseCanvas.height = courseCanvas.parentElement.clientHeight;
}
window.addEventListener("resize", ()=>{ resizeCourse(); drawCourse(); });
resizeCourse();

/* ---- リセット ---- */
function resetHole(){
  stroke = 0;
  clubPower = 0;
  phase = "idle";
  isCourseBallMoving = false;
  courseVel.x = courseVel.y = 0;

  flightFrame = 0;
  flightFramesTotal = 0;

  aimLevel = 0;

  const tee = getTeePos();
  courseBall.x = tee.x;
  courseBall.y = tee.y;

  document.getElementById("impactCursor").style.display = "none";
  updateHoleInfo();
  drawCourse();
}

/* ---- 描画：矢印/ボール/グリーン円 ---- */
function drawArrow(ctx, fromX, fromY, angleRad, length){
  const toX = fromX + Math.cos(angleRad) * length;
  const toY = fromY + Math.sin(angleRad) * length;

  ctx.save();
  ctx.lineCap = "round";
  ctx.lineJoin = "round";

  ctx.strokeStyle = "rgba(255,255,255,.65)";
  ctx.lineWidth = 8;
  ctx.beginPath();
  ctx.moveTo(fromX, fromY);
  ctx.lineTo(toX, toY);
  ctx.stroke();

  ctx.strokeStyle = "rgba(0,0,0,.75)";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(fromX, fromY);
  ctx.lineTo(toX, toY);
  ctx.stroke();

  const headLen = 14;
  const a1 = angleRad + Math.PI * 0.85;
  const a2 = angleRad - Math.PI * 0.85;

  ctx.fillStyle = "rgba(0,0,0,.75)";
  ctx.beginPath();
  ctx.moveTo(toX, toY);
  ctx.lineTo(toX + Math.cos(a1)*headLen, toY + Math.sin(a1)*headLen);
  ctx.lineTo(toX + Math.cos(a2)*headLen, toY + Math.sin(a2)*headLen);
  ctx.closePath();
  ctx.fill();

  ctx.restore();
}

function getCourseAimAngleRad(){
  const g = getGreenCenter();
  const dx = g.x - courseBall.x;
  const dy = g.y - courseBall.y;
  const baseAngle = Math.atan2(dy, dx);
  const offset = (aimLevel * AIM_STEP_DEG) * Math.PI / 180;
  return baseAngle + offset;
}

function drawGreenGuideCourse(){
  const g = getGreenCenter();
  const r = getGreenRadius();

  courseCtx.save();
  courseCtx.strokeStyle = "rgba(255,0,0,.95)";
  courseCtx.lineWidth = 3;
  courseCtx.beginPath();
  courseCtx.arc(g.x, g.y, r, 0, Math.PI*2);
  courseCtx.stroke();

  courseCtx.fillStyle = "rgba(255,0,0,.95)";
  courseCtx.beginPath();
  courseCtx.arc(g.x, g.y, 3, 0, Math.PI*2);
  courseCtx.fill();
  courseCtx.restore();
}

function drawCourse(){
  courseCtx.clearRect(0,0,courseCanvas.width,courseCanvas.height);

  // グリーン赤円
  drawGreenGuideCourse();

  // エイム矢印
  const aimAngle = getCourseAimAngleRad();
  courseCtx.save();
  if(isCourseBallMoving) courseCtx.globalAlpha = 0.35;
  drawArrow(courseCtx, courseBall.x, courseBall.y, aimAngle, Math.min(courseCanvas.width, courseCanvas.height) * 0.18);
  courseCtx.restore();

  // ボール
  courseCtx.fillStyle="white";
  courseCtx.beginPath();
  courseCtx.arc(courseBall.x, courseBall.y, 6, 0, Math.PI*2);
  courseCtx.fill();

  // Stroke（デバッグ）
  courseCtx.fillStyle="rgba(0,0,0,.55)";
  courseCtx.font="12px sans-serif";
  courseCtx.fillText(`Stroke: ${stroke}`, 10, courseCanvas.height-10);
}

/* ---- コース移動：着地即停止＋風(x/y) ---- */
function animateCourse(){
  if(isCourseBallMoving){
    courseBall.x += courseVel.x;
    courseBall.y += courseVel.y;

    const rad = windDirDeg * Math.PI / 180;
    const WIND_SCALE = 0.22;
    courseBall.x += Math.cos(rad) * windSpeed * WIND_SCALE;
    courseBall.y += Math.sin(rad) * windSpeed * WIND_SCALE;

    flightFrame++;

    if(flightFrame >= flightFramesTotal){
      isCourseBallMoving = false;
      courseVel.x = 0;
      courseVel.y = 0;

      if(isOnGreenCourse()){
        showNiceOnAndSwitchToGreen();
      }
    }
  }

  updateHoleInfo();
  drawCourse();
  requestAnimationFrame(animateCourse);
}
animateCourse();

function isOnGreenCourse(){
  const g = getGreenCenter();
  const r = getGreenRadius();
  return Math.hypot(courseBall.x - g.x, courseBall.y - g.y) <= r;
}

function showNiceOnAndSwitchToGreen(){
  const banner = document.getElementById("banner");
  banner.style.display = "block";

  setTimeout(()=>{
    banner.style.display = "none";
    enterGreenMode();
  }, 800);
}

/* ---- クラブ ---- */
document.querySelectorAll(".club-buttons button").forEach(btn=>{
  btn.onclick=()=>{
    if(inGreenMode) return;

    document.querySelectorAll(".club-buttons button")
      .forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    clubPower = Number(btn.dataset.power);

    phase = "vertical";
    cursorX = 0;
    cursorY = 0;
    direction = 1;

    const cursor = document.getElementById("impactCursor");
    cursor.style.display = "block";
    cursor.style.left = "50%";
    cursor.style.top  = "50%";
  };
});

/* ---- カーソル移動 ---- */
function moveCursor(){
  const cursor = document.getElementById("impactCursor");

  if(phase==="vertical"){
    cursorY += direction*2;
    if(cursorY>50 || cursorY<-50) direction*=-1;
    cursor.style.top = (50 + cursorY) + "%";
    cursor.style.left = "50%";
  }else if(phase==="horizontal"){
    cursorX += direction*2;
    if(cursorX>50 || cursorX<-50) direction*=-1;
    cursor.style.left = (50 + cursorX) + "%";
    cursor.style.top  = "50%";
  }else{
    cursor.style.left = "50%";
    cursor.style.top  = "50%";
  }
  requestAnimationFrame(moveCursor);
}
moveCursor();

/* ---- タップ順 ---- */
impactZone.addEventListener("click",()=>{
  if(inGreenMode) return;
  if(clubPower<=0) return;
  if(isCourseBallMoving) return;

  if(phase==="vertical"){
    phase="horizontal";
    direction=1;
  }else if(phase==="horizontal"){
    phase="done";
    swingAndShotCourse();
  }
});

function swingAndShotCourse(){
  // ★コマ送りスイング
  playSwingAnimation();

  stroke += 1;

  const aimAngle = getCourseAimAngleRad();
  const nx = Math.cos(aimAngle);
  const ny = Math.sin(aimAngle);

  const forwardScale = 1 + (-cursorY * 0.004);
  const sideScale    = (cursorX * 0.004);

  const speed = clubPower * 0.03;

  const px = -ny;
  const py = nx;

  courseVel.x = nx * speed * forwardScale + px * speed * sideScale;
  courseVel.y = ny * speed * forwardScale + py * speed * sideScale;

  flightFrame = 0;
  flightFramesTotal = Math.round(30 + speed * 3.2);

  isCourseBallMoving = true;

  setTimeout(()=>{
    phase="idle";
    document.getElementById("impactCursor").style.display="none";
    cursorX=0; cursorY=0;
  }, 650);
}

/* =========================
   GREEN MODE（楕円＋音＋止まる物理＋スコア表示）
========================= */
const greenOverlay = document.getElementById("greenOverlay");
const greenCanvas = document.getElementById("greenCanvas");
const gctx = greenCanvas.getContext("2d");

let inGreenMode = false;

/* ===== スコア設定（このホール固定） ===== */
const HOLE_NO = 1;
const HOLE_PAR = 4;

function scoreLabel(diff){
  if(diff <= -3) return "ALBATROSS";
  if(diff === -2) return "EAGLE";
  if(diff === -1) return "BIRDIE";
  if(diff ===  0) return "PAR";
  if(diff ===  1) return "BOGEY";
  if(diff ===  2) return "DOUBLE BOGEY";
  if(diff ===  3) return "TRIPLE BOGEY";
  return `+${diff}`;
}

/* ===== 効果音（WebAudio） ===== */
let sfxCtx = null;
function getSfxCtx(){
  if(!sfxCtx){
    sfxCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(sfxCtx.state === "suspended") sfxCtx.resume().catch(()=>{});
  return sfxCtx;
}
function playTapSfx(){
  const ctx = getSfxCtx();
  const t0 = ctx.currentTime;

  const o1 = ctx.createOscillator();
  const g1 = ctx.createGain();
  o1.type = "square";
  o1.frequency.setValueAtTime(240, t0);
  o1.frequency.exponentialRampToValueAtTime(120, t0 + 0.03);
  g1.gain.setValueAtTime(0.12, t0);
  g1.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.05);
  o1.connect(g1).connect(ctx.destination);
  o1.start(t0);
  o1.stop(t0 + 0.06);
}
function playCupInSfx(){
  const ctx = getSfxCtx();
  const t0 = ctx.currentTime;

  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = "triangle";
  o.frequency.setValueAtTime(950, t0);
  o.frequency.setValueAtTime(720, t0 + 0.06);

  g.gain.setValueAtTime(0.10, t0);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.35);

  o.connect(g).connect(ctx.destination);
  o.start(t0);
  o.stop(t0 + 0.36);
}

/* ===== 楕円グリーン定義 ===== */
function getGreenEllipse(){
  const cx = greenCanvas.width  * 0.50;
  const cy = greenCanvas.height * 0.54;
  const rx = greenCanvas.width  * 0.44;
  const ry = greenCanvas.height * 0.30;
  return { cx, cy, rx, ry };
}
function insideEllipse(x,y,e){
  const dx = (x - e.cx) / e.rx;
  const dy = (y - e.cy) / e.ry;
  return (dx*dx + dy*dy) <= 1;
}
function resolveEllipseCollision(ball, vel, e){
  const dx = ball.x - e.cx;
  const dy = ball.y - e.cy;

  const val = (dx*dx)/(e.rx*e.rx) + (dy*dy)/(e.ry*e.ry);
  if(val <= 1) return;

  const t = 1 / Math.sqrt(val);
  ball.x = e.cx + dx * t;
  ball.y = e.cy + dy * t;

  let nx = dx / (e.rx*e.rx);
  let ny = dy / (e.ry*e.ry);
  const nlen = Math.hypot(nx, ny) || 1;
  nx /= nlen; ny /= nlen;

  const dot = vel.x*nx + vel.y*ny;
  vel.x = vel.x - 2*dot*nx;
  vel.y = vel.y - 2*dot*ny;

  vel.x *= 0.25;
  vel.y *= 0.25;
}

/* グリーン座標 */
let gBall = { x: 0, y: 0 };
let gVel  = { x: 0, y: 0 };
let gCup  = { x: 0, y: 0, r: 12 };

let gSlope = { ax: 0, ay: 0 };
let gAimLevel = 0;
let gMoving = false;

/* ★矢印の基準角度（常にカップ方向） */
let gAimBaseAngle = -Math.PI/2;
function updateAimBaseToCup(){
  gAimBaseAngle = Math.atan2(gCup.y - gBall.y, gCup.x - gBall.x);
}

let powerT = 0;
let powerDir = 1;
let powerSpeed = 0.018;

let gSwipeActive = false;
let gSwipeStartX = 0;
let gSwipeAccumX = 0;
const G_SWIPE_STEP_PX = 35;
const G_AIM_STEP_DEG = 7;
const G_AIM_MIN = -6;
const G_AIM_MAX =  6;

function resizeGreen(){
  greenCanvas.width = window.innerWidth;
  greenCanvas.height = window.innerHeight;
}
window.addEventListener("resize", ()=>{ resizeGreen(); drawGreen(); });
resizeGreen();

/* コース→グリーン初期位置 */
function courseToGreenStart(){
  const e = getGreenEllipse();

  const gc = getGreenCenter();
  const r  = getGreenRadius() || 1;

  const rx = (courseBall.x - gc.x) / r;
  const ry = (courseBall.y - gc.y) / r;

  let x = e.cx + rx * 55;
  let y = e.cy + e.ry * 0.45 + ry * 35;

  if(!insideEllipse(x,y,e)){
    const dx = x - e.cx, dy = y - e.cy;
    const val = (dx*dx)/(e.rx*e.rx) + (dy*dy)/(e.ry*e.ry);
    const t = 0.98 / Math.sqrt(val);
    x = e.cx + dx*t;
    y = e.cy + dy*t;
  }
  return { x, y };
}

function randomizeCupAndSlope(){
  const e = getGreenEllipse();

  let placed = false;
  for(let i=0;i<80;i++){
    const x = e.cx + (Math.random()*2-1) * e.rx * 0.55;
    const y = e.cy - e.ry*0.35 + (Math.random()*2-1) * e.ry * 0.30;
    if(insideEllipse(x,y,e)){
      gCup.x = x;
      gCup.y = y;
      placed = true;
      break;
    }
  }
  if(!placed){
    gCup.x = e.cx;
    gCup.y = e.cy - e.ry*0.28;
  }
  gCup.r = 13;

  const dir = Math.random()*Math.PI*2;
  const strength = 0.0022 + Math.random()*0.0012;
  gSlope.ax = Math.cos(dir) * strength;
  gSlope.ay = Math.sin(dir) * strength;
}

function updateGreenHUD(){
  const dx = gCup.x - gBall.x;
  const dy = gCup.y - gBall.y;
  const distPx = Math.hypot(dx, dy);
  const ft = Math.max(1, Math.round(distPx / 28));

  const slopeAngle = Math.atan2(gSlope.ay, gSlope.ax);
  const deg = Math.round((slopeAngle * 180/Math.PI + 360) % 360);

  document.getElementById("greenInfo").innerHTML =
    `Hole ${HOLE_NO} Par${HOLE_PAR}<br>Strokes: ${stroke}<br>Dist: ${ft} ft / Slope: ${deg}°`;
}

function setPowerUI(){
  const fill = document.getElementById("powerFill");
  const marker = document.getElementById("powerMarker");

  const pct = Math.round(powerT * 100);
  fill.style.width = pct + "%";
  marker.style.left = `calc(${pct}% - 2px)`;
}

/* 方向：左右スワイプで調整（-6..+6） */
function clampInt(v, min, max){ return Math.max(min, Math.min(max, v|0)); }

greenOverlay.addEventListener("pointerdown", (e)=>{
  if(!inGreenMode) return;

  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  if(tag === "button") return;

  gSwipeActive = true;
  gSwipeStartX = e.clientX;
  gSwipeAccumX = 0;
  greenOverlay.setPointerCapture?.(e.pointerId);
});

greenOverlay.addEventListener("pointermove", (e)=>{
  if(!inGreenMode) return;
  if(!gSwipeActive) return;
  if(gMoving) return;

  const dx = e.clientX - gSwipeStartX;
  const delta = dx - gSwipeAccumX;

  if(Math.abs(delta) >= G_SWIPE_STEP_PX){
    const steps = Math.trunc(delta / G_SWIPE_STEP_PX);
    gSwipeAccumX += steps * G_SWIPE_STEP_PX;

    gAimLevel = clampInt(gAimLevel + steps, G_AIM_MIN, G_AIM_MAX);
    drawGreen();
  }
});

function endGreenSwipe(e){
  if(!gSwipeActive) return;
  gSwipeActive = false;
  gSwipeStartX = 0;
  gSwipeAccumX = 0;
  greenOverlay.releasePointerCapture?.(e.pointerId);
}
greenOverlay.addEventListener("pointerup", endGreenSwipe);
greenOverlay.addEventListener("pointercancel", endGreenSwipe);

/* タップでパット */
greenOverlay.addEventListener("click", (e)=>{
  if(!inGreenMode) return;

  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  if(tag === "button") return;

  if(gMoving) return;
  puttNow();
});

function enterGreenMode(){
  inGreenMode = true;
  greenOverlay.style.display = "block";
  document.getElementById("holeOutBanner").style.display = "none";

  const start = courseToGreenStart();
  gBall.x = start.x;
  gBall.y = start.y;
  gVel.x = 0; gVel.y = 0;
  gMoving = false;

  gAimLevel = 0;

  powerT = 0.15;
  powerDir = 1;

  randomizeCupAndSlope();
  updateAimBaseToCup();
  gAimLevel = 0;

  updateGreenHUD();
  setPowerUI();
  drawGreen();
}

document.getElementById("backToCourse").onclick = ()=>{
  inGreenMode = false;
  greenOverlay.style.display = "none";
};

document.getElementById("stayBtn").onclick = ()=>{
  inGreenMode = false;
  greenOverlay.style.display = "none";
};

document.getElementById("nextHoleBtn").onclick = ()=>{
  inGreenMode = false;
  greenOverlay.style.display = "none";

  windSpeed = 0.8 + Math.random()*2.2;
  windDirDeg = Math.random()*360;
  updateWindUI();

  resetHole();
};

function getGreenAimAngle(){
  const offset = (gAimLevel * G_AIM_STEP_DEG) * Math.PI / 180;
  return gAimBaseAngle + offset;
}

function puttNow(){
  playTapSfx();

  // ★パットも打数に加える
  stroke += 1;

  const base = 7.0;
  const speed = base * (0.20 + powerT * 0.80);

  const a = getGreenAimAngle();
  gVel.x = Math.cos(a) * speed;
  gVel.y = Math.sin(a) * speed;

  gMoving = true;
}

function drawGreen(){
  const w = greenCanvas.width, h = greenCanvas.height;
  gctx.clearRect(0,0,w,h);

  const e = getGreenEllipse();

  // 背景は真っ黒
  gctx.fillStyle = "black";
  gctx.fillRect(0,0,w,h);

  // 外側（濃い緑＝フリンジ）
  gctx.save();
  gctx.fillStyle = "rgba(22,120,70,1)";
  gctx.globalAlpha = 0.95;
  gctx.beginPath();
  gctx.ellipse(e.cx, e.cy, e.rx*1.04, e.ry*1.04, 0, 0, Math.PI*2);
  gctx.fill();
  gctx.restore();

  // グリーン本体
  const grad = gctx.createRadialGradient(
    e.cx - e.rx*0.25, e.cy - e.ry*0.25, 20,
    e.cx, e.cy, Math.max(e.rx,e.ry)*1.05
  );
  grad.addColorStop(0, "rgba(80,220,140,1)");
  grad.addColorStop(1, "rgba(25,140,85,1)");

  gctx.fillStyle = grad;
  gctx.beginPath();
  gctx.ellipse(e.cx, e.cy, e.rx, e.ry, 0, 0, Math.PI*2);
  gctx.fill();

  // 楕円内クリップ（傾斜線などは中だけ）
  gctx.save();
  gctx.beginPath();
  gctx.ellipse(e.cx, e.cy, e.rx, e.ry, 0, 0, Math.PI*2);
  gctx.clip();

  // 傾斜ライン
  const cx = w*0.5;
  const cy = h*0.5;
  const a = Math.atan2(gSlope.ay, gSlope.ax);

  gctx.save();
  gctx.globalAlpha = 0.18;
  gctx.strokeStyle = "white";
  gctx.lineWidth = 2;

  for(let i=-6;i<=6;i++){
    const off = i*50;
    const x1 = cx + Math.cos(a + Math.PI/2)*off - Math.cos(a)*900;
    const y1 = cy + Math.sin(a + Math.PI/2)*off - Math.sin(a)*900;
    const x2 = cx + Math.cos(a + Math.PI/2)*off + Math.cos(a)*900;
    const y2 = cy + Math.sin(a + Math.PI/2)*off + Math.sin(a)*900;

    gctx.beginPath();
    gctx.moveTo(x1,y1);
    gctx.lineTo(x2,y2);
    gctx.stroke();
  }
  gctx.restore();

  // カップ
  gctx.save();
  gctx.fillStyle = "rgba(0,0,0,.55)";
  gctx.beginPath();
  gctx.arc(gCup.x, gCup.y, gCup.r, 0, Math.PI*2);
  gctx.fill();

  gctx.strokeStyle = "rgba(255,255,255,.35)";
  gctx.lineWidth = 2;
  gctx.beginPath();
  gctx.arc(gCup.x, gCup.y, gCup.r, 0, Math.PI*2);
  gctx.stroke();
  gctx.restore();

  // 矢印（静止中のみ）
  if(!gMoving){
    const ang = getGreenAimAngle();
    drawArrow(gctx, gBall.x, gBall.y, ang, 90);
  }

  // ボール
  gctx.fillStyle = "white";
  gctx.beginPath();
  gctx.arc(gBall.x, gBall.y, 9, 0, Math.PI*2);
  gctx.fill();

  // 影
  gctx.fillStyle = "rgba(0,0,0,.25)";
  gctx.beginPath();
  gctx.ellipse(gBall.x+2, gBall.y+10, 10, 5, 0, 0, Math.PI*2);
  gctx.fill();

  gctx.restore(); // clip解除

  updateGreenHUD();
}

/* グリーン物理（止まるように強めの抵抗） */
function animateGreen(){
  if(inGreenMode){
    // パワーゲージ往復
    powerT += powerDir * powerSpeed;
    if(powerT >= 1){ powerT = 1; powerDir = -1; }
    if(powerT <= 0){ powerT = 0; powerDir =  1; }
    setPowerUI();

    if(gMoving){
      // 傾斜
      gVel.x += gSlope.ax;
      gVel.y += gSlope.ay;

      // 位置更新
      gBall.x += gVel.x;
      gBall.y += gVel.y;

      // 摩擦
      const FRICTION = 0.962;
      gVel.x *= FRICTION;
      gVel.y *= FRICTION;

      // 転がり抵抗（一定量を毎フレーム削る）
      let sp = Math.hypot(gVel.x, gVel.y);
      if(sp > 0.0001){
        const ROLL_RESIST = 0.028;
        gVel.x -= (gVel.x / sp) * ROLL_RESIST;
        gVel.y -= (gVel.y / sp) * ROLL_RESIST;
      }

      // 楕円外に出ない
      const e = getGreenEllipse();
      resolveEllipseCollision(gBall, gVel, e);

      sp = Math.hypot(gVel.x, gVel.y);

      // カップ判定（近い＆遅い）
      const d = Math.hypot(gBall.x - gCup.x, gBall.y - gCup.y);
      if(d <= gCup.r*0.92 && sp < 1.6){
        gMoving = false;
        gVel.x = 0; gVel.y = 0;
        updateAimBaseToCup();
        gAimLevel = 0;
        showHoleOut();
      }

      // 完全停止
      if(sp < 0.22){
        gMoving = false;
        gVel.x = 0; gVel.y = 0;
        updateAimBaseToCup();
        gAimLevel = 0;
      }
    }

    drawGreen();
  }

  requestAnimationFrame(animateGreen);
}
animateGreen();

function showHoleOut(){
  playCupInSfx();

  const total = stroke;
  const diff = total - HOLE_PAR;
  const label = scoreLabel(diff);

  const box = document.getElementById("holeOutBanner");
  const t = document.getElementById("holeOutText");
  t.textContent = `Total: ${total} / Par${HOLE_PAR}  →  ${label}`;
  box.style.display = "flex";
}

/* ====== 初回描画 ====== */
drawCourse();
updateHoleInfo();
</script>

</body>
</html>
